<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
</head>
<body>
<canvas id="game_canvas" width="800" height="600"></canvas>
<script>
var car_x = 75, car_y = 75;
var car_x_spd = 6, car_y_spd = 8;
var canvas, canvas_context;
var score = 0;
var gameover = false;
const score_font = "30px Arial", score_font_color = "white", score_height = 100;

const track_w = 40,
      track_h = 40,
      track_gap = 1,
      track_cols = 20,
      track_rows = 15;

//var track_grid = new Array(track_cols * track_rows);
var track_grid = [
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
    1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
    1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
    1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1,
    1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
    1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
    1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
    1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
    1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
    1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
    ];

window.onload = function() {
    // Get canvas size from HTML tag
    canvas = document.getElementById('game_canvas');
    canvas_context = canvas.getContext('2d');

    canvas.addEventListener('mousedown', handle_mouse_click);

    var fps = 30;
    setInterval(function(){
        move_car();
        draw_this();
    }, 1000/fps);

    reset_car();
}

function draw_this() {
    draw_box(0, 0, canvas.width, canvas.height, 'black');

    draw_tracks();

    draw_circle(car_x, car_y, 10, 'red');

    draw_score(canvas.width/2, score_height, score, score_font_color, score_font);
}

function draw_score(x, y, score, color, font) {
    canvas_context.fillStyle = color;
    canvas_context.font = font;
    canvas_context.textAlign = "center";
    canvas_context.fillText(score, x, y);
}

function handle_mouse_click(evt) {
    if (gameover) {
        score = 0;
        gameover = false;
    }
    move_car();
    draw_this();
}

function draw_circle(x, y, radius, color) {
    canvas_context.fillStyle = color; // Set fill color
    canvas_context.beginPath(); // Declares this as a new, separate object
    canvas_context.arc(x, y, radius, 0, Math.PI*2, true); // (x, y, radius, start_angle, end_angle, draw_anticlockwise=True)
    canvas_context.fill(); // Color the shape with the current fillStyle
}

function draw_box(x, y, width, height, color) {
    canvas_context.fillStyle = color; // Set fill color
    canvas_context.fillRect(x, y, width, height); // Set canvas position and size (x, y, w, h)
}

function draw_tracks() {
    for(var col = 0; col < track_cols; col++) {
        for(var row = 0; row < track_rows; row++) {
            if( track_exists(col, row) ) {

                var track_x = col * track_w;
                var track_y = row * track_h;

                if(row < 0){
                    check_for_and_bounce_track(track_x, track_y, false);
                } else {
                    draw_box(track_x, track_y, (track_w - track_gap), (track_h - track_gap), 'blue');
                }
            }
        }
    }
}

function bounce_off_track_at_pixel_coord(pixel_x, pixel_y) {
    var tile_col = Math.floor(pixel_x / track_w);
    var tile_row = Math.floor(pixel_y / track_h);

    console.log(tile_col, tile_row);

    if (tile_col < 0 || tile_col >= track_cols ||
        tile_row < 0 || tile_row >= track_rows) {
        return false;
    }

    var track_index = track_tile_to_index(tile_col, tile_row);

    console.log("track index:", track_index);

    if(track_grid[track_index] == 1) {
        var prev_tile_col = Math.floor((car_x - car_x_spd) / track_w);
        var prev_tile_row = Math.floor((car_y - car_y_spd) / track_h);

        var both_tests_failed = true;
        
        if(prev_tile_col != tile_col){
            var adjacent_track = track_tile_to_index(prev_tile_col, tile_row);
            console.log("adj_COL:", adjacent_track, "grid:", track_grid[adjacent_track]);
            if(track_grid[adjacent_track] != 1){
                car_x_spd *= -1;
                both_tests_failed = false;
            }
        }

        if(prev_tile_row != tile_row){
            var adjacent_track = track_tile_to_index(tile_col, prev_tile_row);
            console.log("adj_ROW:", adjacent_track, "grid:", track_grid[adjacent_track]);
            if(track_grid[adjacent_track] != 1){
                car_y_spd *= -1;
                both_tests_failed = false;
            }
        }

        if(both_tests_failed){
            car_x_spd *= -1;
            car_y_spd *= -1;
        }
    }
}

function track_tile_to_index(tile_col, tile_row) {
    return (tile_col + (track_cols * tile_row));
}

function track_exists(track_tile_col, track_tile_row) {
    var track_index = track_tile_to_index(track_tile_col, track_tile_row);
    return (track_grid[track_index] == 1);
}

function reset_car() {
    car_x = canvas.width/2 + 50;
    car_y = canvas.height/2;
}

function move_car() {
    if(car_x < 0) {
        car_x_spd *= -1;
    }

    if(car_x > canvas.width) {
        car_x_spd *= -1;
    }

    if(car_y < 0) {
        car_y_spd *= -1;
    }

    if(car_y > canvas.height) {
        reset_car();
    }

    bounce_off_track_at_pixel_coord(car_x, car_y);

    car_x += car_x_spd;
    car_y += car_y_spd;
}

function check_gameover() {
    for(var i = 0; i < (track_cols * track_rows); i++) {
        if(track_grid[i]){
            gameover = false;
            break;
        }else if(!track_grid[i]){
            gameover = true;
            console.log("Gameover set!");
        }
    }

    if(gameover){
        reset_tracks();
        reset_car();
        score = 0;
    }
}


</script>
</body>
</html>
